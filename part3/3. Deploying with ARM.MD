[[_TOC_]]

# Setup
## Login to Azure from the command line
```bash
az login --tenant 1491bbb5-26ff-4146-a689-da9d7f9df86f
```

Follow the instructions to log into your BJSS Azure account in a browser

Official Install docs: https://docs.microsoft.com/en-us/cli/azure/install-azure-cli

# Running our ARM Templates
Firstly we are going to set two environment variables onto your shell.
The variables are going to be called teamName & userId

*Replace the values with the correct ones for your team and user id as follows:*

```bash
teamName="<your-team-name>"
userId="<your-user-id>"
```

We can verify these variables have been set for using the following cmd:

```bash
echo $teamName
echo $userId
```

Now we have the environment variables set, we need to change to the arm-deployment directory

```bash
cd ~/code-to-cloud/day1/exercises/arm-deployment/modules
```
Once navigated to the ARM directory, you will now need to create a Resource Group.\
This resource group is a container for all of your azure services.
More info available [here](https://docs.microsoft.com/en-us/azure/azure-resource-manager/management/manage-resource-groups-portal#what-is-a-resource-group).

```bash
# Prior to running the command remember to check the values of the environment variables 'teamName' & 'userId' have been set!
az group create --name rg-academyarm-$teamName-$userId --location uksouth
```
Following the successful creation of your resource group we are now going to a validate our template with Azure.\
To do this, run the following command:

```bash
az deployment group validate --resource-group rg-academyarm-$teamName-$userId \
--template-file deployvm.json \
--query properties.outputs.azurerm_public_ip \
--parameters team_name="$teamName" user_id="$userId"
```

If the command doesn't return an error, then Azure has found no issue with our template. _Good news!_

Let's now run a 'what-if' scenario to Azure to see what changes we will be making to that newly built resource group. Run the following command to do this:

_Hint: To run the deployment without doing a 'what-if', you just remove the `-c` option._

```bash
az deployment group create -c --resource-group rg-academyarm-$teamName-$userId \
--template-file deployvm.json \
--query properties.outputs.azurerm_public_ip \
--parameters team_name="$teamName" user_id="$userId"
```

To break the command down:
* We are firstly telling Azure we want to do a deployment into an Azure Resource Group.
* We specify that we want to create a deployment and we provide the `-c` option to the command which sets it to `what-if`
* This command is the 'what-if' syntax that will tell Azure we want to see what changes will happen prior to us doing the deployment.

Example - The deployment will update the following scope:

```
Scope: /subscriptions/993d9215-8911-4938-8121-9608c3ac1fd5/resourceGroups/rg-academyarm-yourteamname-youruserid

  + Microsoft.Compute/virtualMachines/vm-academyarm-yourteamname-youruserid [2020-06-01]

      apiVersion:                                                            "2020-06-01"
      id:                                                                    "/subscriptions/993d9215-8911-4938-8121-9608c3ac1fd5/resourceGroups/rg-academyarm-yourteamname-youruserid/providers/Microsoft.Compute/virtualMachines/vm-academyarm-yourteamname-youruserid"
      location:                                                              "uksouth"
      name:                                                                  "vm-academyarm-yourteamname-youruserid"
      properties.hardwareProfile.vmSize:                                     "Standard_B1ls"
      properties.networkProfile.networkInterfaces: [
        0:

          id: "/subscriptions/993d9215-8911-4938-8121-9608c3ac1fd5/resourceGroups/rg-academyarm-yourteamname-youruserid/providers/Microsoft.Network/networkInterfaces/nic-academyarm-yourteamname-youruserid"

      ]
```

Once Azure has given you the rundown on what its going to change and implement it will ask if you want to deploy: 

```
Are you sure you want to execute the deployment? (y/n):
```

Have a look through the scenario and if your happy with the infrastructure we are going to be building enter `Y`

---
If during the `az deployment`, you receive an error message similar to:
```
unable to locate package nginx
```
... unfortunately this is a known issue that happens for a select few students, occurring randomly with no obvious root cause. If this happens, please remove the Azure Resource Group that contains the VM and try the run again.

---

## Looking in the Portal
We can look at the resources created in the portal (look for the resource group that matches your team and name): https://portal.azure.com/?quickstart=True#blade/HubsExtension/BrowseResourceGroups
Once you have navigate to the Resource Group you should be able to see a 'Deployments' option and a status that is next to that.
Hopefully saying 'Deploying' or 'Succesful'

## Querying the Key Vault
Within this ARM template we generate a password using a unique string and then stash that password inside an Azure [Key Vault](https://azure.microsoft.com/en-gb/services/key-vault/).\
Following the deployment of your ARM templates you can now navigate to your newly created Key Vault.

To find the Key Vaults section in the Azure portal, use the Search Bar (very top and centre on any page in the Azure portal) to search for **Key Vaults**. You can also find it from the _All services_ menu, then _Security_, then finally _Key Vaults_.

When you open the Key Vault you will be presented with a list of different options on the left pane.
One of these options is the _Access policy_ pane. Click into that when you see it.

Once in that panel, click on the '+ Create' button (located at the top of the right-hand side Key Vault pane).
You'll see a selection of check boxes. Under the _Secret permissions_ column, select 'Get, List, Set'. No others should be selected here. Then select the _Next_ button at the bottom of the page.

On the next tab, _Principal_, you'll need to add yourself as the principal. Enter _your whole BJSS email address_ to find your user account, then select it. Note that typing your name here, or entering partial search terms _will not work_ - it must be your _whole email address_ typed or pasted in - otherwise, it will not find you. Then select the _Next_ button at the bottom of the page.

NOTE: is you can't find it by email run the command:
```
az ad signed-in-user show --query 'id'
```
and use the id to try and find yourself as principal.

The next tabs are optional - select the _Next_ button at the bottom of the page on each, then finally the _Create_ button.

Once you have created an access policy you should now be able to go to the 'Secrets' panel.
Inside of there you will see two secrets:

* `OSlogin`
* `OSPassword`

Select the `OSPassword` secret. Once there, it'll display all of the versions of that secret. As this is freshly created, there will only be one version (with a random value underneath the _CURRENT VERSION_ heading), so select it to take you to the details of the secret you have selected.

Once you have the details page, use the copy link next to the secret value to copy the current value of the `OSPassword` secret, as we will need this for the following steps.

## Accessing your VM
Once you have your password, you'll need to run the following command to obtain your VMs public IP:

```bash
az network public-ip list -g rg-academyarm-$teamName-$userId --query [].ipAddress -otsv
```

We can access our VM using the public IP Address. In a browser navigate the IP address output by your deployment: `http://<your vm public ip address>`

You should see the Nginx Welcome Page:

![nginx](./images/nginx_page.png)

Another thing we can do is get remote shell access to the machine. To do this we use a utility (and protocol) called [SSH](https://en.wikipedia.org/wiki/SSH_(Secure_Shell))

```bash
# Create an SSH connection to VM (don't include the angle brackets! <>)
ssh $userId@<your vm public ip address>

# Output:
Welcome to Ubuntu 18.04.5 LTS (GNU/Linux 5.4.0-1039-azure x86_64)
lorem@ipsumvm:~$:
```

Now we are logged into the VM we can run various commands for example we can check the resource usage on the machine:

```bash
top
# To quit the top command, press q

# logout by typing exit:
exit

# Output:
logout
Connection to xxx.xxx.xxx.xxx closed.
```

## Making a Change In ARM
Because we have now entered a Key Vault policy that isn't our ARM deployment when we rerun the ARM code we are going to remove our own access.\
So to mitigate this we are going to now add your user to the ARM templates access policy.

Firstly we will need to run an Azure CLI command to get your user's `objectId`:

_nb_: Output changed from `objectId` to `id` in newer `az` tool releases. Make sure the tool is up to date if the following command doesn't give a UUID in the output:

```bash
az ad signed-in-user show --query 'id' -otsv
```

Now we will use VS Code to make changes to the access policy with the objectId we have.
If you aren't using VS Code, substitute `code` with your editor in the guide below:

Run `code deployvm.json` to open up your file, then find 'accessPolicies' in the file. This should present you with something like is shown below:

```json
"bypass": "AzureServices",
"virtualNetworkRules": [
            ]
        },
        "accessPolicies": [
            {
                "tenantId": "[variables('tenant_id')]",
                "objectId": "[variables('ACAdmins')]",
                "permissions": {
                    "secrets": [ "Get", "Set", "List" ]
                }
            }
        ]
```

Now we want to enter the new access policy rule.

Modify the above to look like the following example. Don't forget to also substitute `<the-id-copied-from-the-az-ad-command-you-ran-earlier>` with the value from the `az ad` command you ran earlier.

```json
"bypass": "AzureServices",
"virtualNetworkRules": [
            ]
        },
        "accessPolicies": [
            {
                "tenantId": "[variables('tenant_id')]",
                "objectId": "[variables('ACAdmins')]",
                "permissions": {
                    "secrets": [ "Get", "Set", "List" ]
                }
            },
            {
                "tenantId": "[variables('tenant_id')]",
                "objectId": "<the-id-copied-from-the-az-ad-command-you-ran-earlier>",
                "permissions": {
                    "secrets": [ "Get", "Set", "List" ]
                }
            }
        ]
```
_Don't forget to save your changes!_

Now we have made a change to the tags on the resource group. Using the whole command we used for `az deployment group create...` earlier, run the command again - if you set the default variables in the above steps you can run the same command again verbatim, excluding the `-c` flag as we don't need to 'what-if' it. 

You should see that ARM wants to do an in-place update and add the new Tag to the resource.

```bash
Example Output:
    ~ properties.accessPolicies: [
      + 1:

          objectId:     "4ebcd214-68c4-4efe-8886-6a260ad766db"
          permissions.secrets: [
            0: "Get"
            1: "Set"
            2: "List"
          ]
          tenantId:     "4xxd214-xxx-4xxe-8886-6xx60axx6db"
```

It will prompt to continue:
```
Are you sure you want to execute the deployment? (y/n):
```
Have a look through the scenario and if your happy enter `Y`

You can check the new Access policy appears in the Azure portal by viewing your Key Vault.

## Destroying Our Infrastructure
To remove our infrastructure we will now be deleting it by doing the following

````bash
# As with all delete commands, With great power there must also come great responsibility.
# Always triple check when deleting a resourceGroup!
# Are you sure you want to perform this operation? (y/n):
az group delete --name rg-academyarm-$teamName-$userId 
````
